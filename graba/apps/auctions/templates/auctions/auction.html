{% extends 'base/base_column.html' %}
{% load static %}
{% load custom_filters %}

{% block navbar %} {% include 'auctions/includes/create_navbar.html' %} {% endblock %}

{% block extra_css %} <link rel="stylesheet" type="text/css" href="{% static 'auctions/css/base.css' %}"> {% endblock %}

{% block title %}Create Auction{% endblock %}

{% block main_column %}
<div class="d-flex flex-column align-items-center gap-4 pt-4">



    <!-- FIRST SECTION -->
    <div class="card bg-white rounded shadow py-4 px-4 w-100">

        <h2>{{ object.title }}</h2>
        <hr>

        <div class="d-flex gap-3">

            <!-- IMAGE ON THE LEFT WITH FAVORITE ICON -->
            {% if object.image.url %}
                <div class="position-relative flex-shrink-0" style="width: auto; max-width: 300px;">
                    <a href="{% url 'auctions:auction-detail' object.id %}">
                        <img src="{{ object.image.url }}"
                            class="img-fluid rounded h-100"
                            alt="{{ object.title }}"
                            style="object-fit:contain; background-color:#f8f9fa; width:100%; height:100%;">
                    </a>

                    {% if request.user.is_authenticated %}
                        <div class="favorite-toggle"
                            data-auction="{{ object.id }}"
                            style="position:absolute; top:10px; right:10px; cursor:pointer;">
                            
                            {% if object.id in user_favorites %}
                                <i class="bi bi-bookmark-fill text-dark"></i>
                            {% else %}
                                <i class="bi bi-bookmark text-dark"></i>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- TEXT ON THE RIGHT -->
            <div class="d-flex flex-column flex-grow-1 gap-3">

                <!-- DESCRIPTION SECTION -->
                <div class="p-3 bg-light rounded shadow-sm d-flex flex-column">
                    <h5 class="mb-2"><i class="bi bi-file-text"></i> Description</h5>
                    <p class="mb-0">{{ object.description }}</p>
                </div>

                <!-- TECHNICAL DETAILS SECTION -->
                <div class="p-3 bg-light rounded shadow-sm d-flex flex-column">
                    <h5 class="mb-2"><i class="bi bi-gear"></i> Technical Details</h5>
                    <p class="mb-0">{{ object.technical_details }}</p>
                </div>

                <!-- OTHER INFO IN TWO COLUMNS -->
                <div class="d-flex gap-3 align-items-stretch">

                    <!-- LEFT INFO -->
                    <div class="d-flex flex-column gap-3 flex-grow-1">
                        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column flex-grow-1">
                            <h5 class="mb-2"><i class="bi bi-calendar"></i> Dates</h5>
                            <p class="mb-0"><strong>Start:</strong> {{ object.start_date|date:"d M Y H:i" }}</p>
                            <p class="mb-0"><strong>End:</strong> {{ object.end_date|date:"d M Y H:i" }}</p>
                        </div>
                        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column flex-grow-1">
                            <h5 class="mb-2"><i class="bi bi-clock"></i> {{ auction.ftime_tag }}</h5>
                            {% if object.status == "SCHEDULED" or object.status == "OPEN" %}
                                <p class="mb-0 flex-grow-1">
                                    <span id="auction-timer">0h 0m 0s</span>
                                </p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- RIGHT INFO -->
                    <div class="d-flex flex-column gap-3 flex-grow-1">
                        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column flex-grow-1">
                            <h5 class="mb-2"><i class="bi bi-info-circle"></i> Status</h5>
                            <p class="mb-0">{{ object.status }}</p>
                        </div>
                        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column flex-grow-1">
                            <h5 class="mb-2"><i class="bi bi-currency-euro"></i> Pricing</h5>
                            <div id="highest-bid-tag">
                                {% if highest_bid %}
                                    <p class="mb-0"><strong>Highest Offer:</strong> €{{ highest_bid|cents_to_price }}</p>
                                {% else %}
                                    <p class="mb-0"><strong>Minimum Price:</strong> €{{ object.min_price_cents|cents_to_price }}</p>
                                    {% if object.buy_now_price_cents %}
                                        <p class="mb-0"><strong>Buy Now Price:</strong> €{{ object.buy_now_price_cents|cents_to_price }}</p>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>



    <!-- SECOND SECTION -->
    <div class="card bg-white rounded shadow py-4 px-4 w-100">

        <h4>Seller Info</h4>
        <hr>

        <div class="d-flex gap-3 align-items-start flex-wrap">

            <!-- LEFT COLUMN -->
            {% if object.seller.role.user.legal_type == "SHOPKEEPER" %}
                <div class="d-flex flex-column gap-3 flex-grow-1 min-w-200px">
                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">Business Name:</strong>
                        <span>{{ object.seller.role.user.shopkeeper.business_name }}</span>
                    </div>

                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">Headquarters:</strong>
                        <span>{{ object.seller.role.user.shopkeeper.headquarters_address }}</span>
                    </div>

                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">VAT Number:</strong>
                        <span>{{ object.seller.role.user.shopkeeper.iva_number }}</span>
                    </div>
                </div>
            {% endif %}
            
            <!-- RIGHT COLUMN -->
            <div class="d-flex flex-column gap-3 flex-grow-1 min-w-200px">
                <div class="d-flex align-items-center justify-content-between">

                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">Username:</strong>
                        <span>{{ object.seller.role.user.username }}</span>
                    </div>

                    <!-- LINK PROFILO -->
                    <a href="{% url 'accounts:profile' object.seller.role.user.id %}" 
                    class="d-flex align-items-center text-primary text-decoration-none">
                        <i class="bi bi-person-circle me-1"></i> View Profile
                    </a>
                </div>

                {% if object.seller.role.user.legal_type == "PRIVATE" and profile_user.first_name or profile_user.last_name %}
                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">Full Name:</strong>
                        <span>{{ profile_user.first_name }} {{ profile_user.last_name }}</span>
                    </div>
                {% endif %}

                <div class="d-flex align-items-center">
                    <strong class="me-3" style="width: 150px;">Collection Address:</strong>
                    <span>{{ object.seller.collection_address }}</span>
                </div>
            </div>

        </div>
    </div>



    <!-- THIRD SECTION: Winner -->
    {% if object.status == "CLOSED" and winner_offer %}
    <div class="card bg-white rounded shadow py-4 px-4 w-100">

        <h4>Auction Winner</h4>
        <hr>

        <div class="d-flex gap-3 align-items-start flex-wrap">

            <!-- LEFT COLUMN: Winning Offer -->
            <div class="d-flex flex-column gap-3 flex-grow-1 min-w-200px">
                <div class="d-flex align-items-center">
                    <strong class="me-3" style="width: 150px;">Type:</strong>
                    {% if winner_offer.offer.type == "BID" %}
                        Highest Bid
                    {% else %}
                        Buy Now
                    {% endif %}
                </div>

                <div class="d-flex align-items-center">
                    <strong class="me-3" style="width: 150px;">Amount:</strong>
                    €{{ winner_offer.offer.amount_cents|cents_to_price }}
                </div>

                <div class="d-flex align-items-center">
                    <strong class="me-3" style="width: 150px;">Date:</strong>
                    {{ winner_offer.offer.offer_time|date:"d M Y H:i" }}
                </div>
            </div>

            <!-- RIGHT COLUMN: Winner Information -->
            <div class="d-flex flex-column gap-3 flex-grow-1 min-w-200px">
                <div class="d-flex align-items-center justify-content-between">
                    
                    <div class="d-flex align-items-center">
                        <strong class="me-3" style="width: 150px;">Username:</strong>
                        {{ winner_offer.offer.buyer.role.user.username }}
                    </div>

                    <a href="{% url 'accounts:profile' winner_offer.offer.buyer.role.user.id %}" 
                    class="d-flex align-items-center text-primary text-decoration-none">
                        <i class="bi bi-person-circle me-1"></i> Visit Profile
                    </a>
                </div>

                {% if winner_offer.created_at %}
                <div class="d-flex align-items-center">
                    <strong class="me-3" style="width: 150px;">Finalized at:</strong>
                    {{ winner_offer.created_at|date:"d M Y H:i" }}
                </div>
                {% endif %}
            </div>

        </div>
    </div>
    {% endif %}



    <!-- FOURTH SECTION: Bid and BuyNow Section -->
    {% if object.status == "OPEN" %}
    <div class="card bg-white rounded shadow py-4 px-4 w-100 position-relative">

        <h4>Bids and Buy Section</h4>
        <hr>
    
        <div class="d-flex flex-column gap-3">

            <!-- NO BIDS TEXT -->
            <p id="no-bids-found-text" class="mb-0 d-none">No bids found.</p>
            
            <!-- HIGHEST BID BADGE -->
            <div class="position-absolute top-0 end-0 m-3">
                <span id="highest-bid-live-badge"
                    data-amount="0"
                    class="badge bg-primary bg-gradient p-2 px-3 shadow-sm d-none">
                    <i class="bi bi-trophy me-1"></i>
                    Highest: €{{ highest_bid|default:0|cents_to_price }}
                </span>
            </div>

            <!-- BIDS LIST -->
            <div id="bid_list_section" class="p-3 bg-light rounded shadow-sm d-none">
                <h5 class="mb-3">
                    <i class="bi bi-list-ul me-1"></i> Latest Bids
                </h5>

                <div style="max-height: 250px; overflow-y:auto;">
                    <ul id="bid-list" class="list-group list-group-flush">
                        {% for b in bids %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ b.buyer.role.user.username }}</strong>
                                    <small class="text-muted ms-2">
                                        {{ b.offer_time|date:"H:i d M Y" }}
                                    </small>
                                </div>
                                <span class="fw-semibold">
                                    €{{ b.amount_cents|cents_to_price }}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- PLACE BID FORM -->
            {% if is_buyer %}
            <div class="p-3 bg-light rounded shadow-sm">
                <h5 class="mb-3">
                    <i class="bi bi-tag-fill me-1"></i> Place a Bid
                </h5>

                <form method="POST" id="bid-form" class="d-flex align-items-center gap-3 flex-wrap">
                    {% csrf_token %}

                    <div class="input-group" style="max-width: 220px;">
                        <span class="input-group-text">€</span>
                        <input type="number"
                            class="form-control"
                            name="amount"
                            step="0.01"
                            min="0.01"
                            placeholder="Your bid"
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-arrow-up-circle me-1"></i> Bid
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- BUY NOW FORM -->
            {% if is_bn_enabled and is_buyer %}
            <div id="buy_now_section" class="p-3 bg-light rounded shadow-sm d-none">
                <h5 class="mb-3">
                    <i class="bi bi-bag-fill me-1"></i> Buy Now
                </h5>
                
                <form method="POST" id="buy-now-form" class="d-flex align-items-center gap-3">
                    {% csrf_token %}

                    <p class="mb-0">
                        <strong>Price:</strong>
                        €{{ object.buy_now_price_cents|cents_to_price }}
                    </p>

                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-lightning-fill me-1"></i> Buy
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- AUCTION ERROR LIST -->
            <div id="auction_error_list" class="alert alert-danger list-icon list-icon-error d-none">
                <ul class="errorlist" id="id_title_error"></ul>
            </div>

        </div>

    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    /* ============================================================
       HELPERS
    ============================================================ */
    const show = el => el?.classList.remove("d-none");
    const hide = el => el?.classList.add("d-none");

    const formatDate = dt => new Date(dt).toLocaleString("en-GB", {
        hour: "2-digit", minute: "2-digit",
        day: "2-digit", month: "short", year: "numeric"
    });

    function startAuctionTimer(endTime) {
        const timerEl = document.getElementById("auction-timer");
        if (!timerEl) return;

        function updateTimer() {
            const now = new Date().getTime();
            const distance = new Date(endTime).getTime() - now;

            if (distance <= 0) {
                timerEl.textContent = "0h 0m 0s";
                clearInterval(interval);
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const arr = [];
            if (days) arr.push(`${days}d`);
            if (hours) arr.push(`${hours}h`);
            if (minutes) arr.push(`${minutes}m`);
            if (seconds || arr.length === 0) arr.push(`${seconds}s`);

            timerEl.textContent = arr.slice(0, Math.min(2, arr.length)).join(" ");
        }

        updateTimer(); // update immediately
        const interval = setInterval(updateTimer, 1000);
    }


    /* ============================================================
       AUCTION STATE
    ============================================================ */
    const AUCTION_STATE = "{{ object.status }}";

    const bidList = document.getElementById('bid-list');
    const highestBidBadge = document.getElementById('highest-bid-live-badge');
    const highestBidTag = document.getElementById('highest-bid-tag');
    const bidListSection = document.getElementById('bid_list_section');
    const buyNowSection = document.getElementById('buy_now_section');
    const noBidsFoundTxt = document.getElementById('no-bids-found-text');
    const aucAlert = document.getElementById('auction_error_list');
    const titleErr = document.getElementById('id_title_error');

    /* ============================================================
       AUCTION STATE DISPATCHER
    ============================================================ */
    const AuctionStates = {
        SCHEDULED: () => {
            startAuctionTimer("{{ object.start_date|date:'c' }}");
        },
        OPEN: () => {
            initBidForm();
            initBuyNowForm();
            updateBidListVisibility();
            startAuctionTimer("{{ object.end_date|date:'c' }}");
        },
        CLOSED: () => { /* static UI only */ },
        CANCELLED: () => { /* static UI only */ },
    };

    if (AuctionStates[AUCTION_STATE]) {
        AuctionStates[AUCTION_STATE]();
    }

    /* ============================================================
       BID FORM
    ============================================================ */
    function initBidForm() {
        const bidForm = document.getElementById('bid-form');
        if (!bidForm) return;

        const bidInput = bidForm.querySelector('input[name="amount"]');
        const csrfToken = bidForm.querySelector('[name=csrfmiddlewaretoken]').value;

        bidForm.addEventListener('submit', async e => {
            e.preventDefault();
            const response = await fetch("{% url 'auctions:auction-bid' object.id %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken, "Accept": "application/json" },
                body: new URLSearchParams({ amount: bidInput.value })
            });
            const data = await response.json();

            titleErr.innerHTML = "";
            if (!data.success) {
                show(aucAlert);
                const li = document.createElement("li");
                li.textContent = data.error || "Unknown error occurred.";
                titleErr.appendChild(li);
                return;
            }

            hide(aucAlert);
            bidInput.value = "";
        });
    }

    /* ============================================================
       BUY NOW FORM
    ============================================================ */
    function initBuyNowForm() {
        const buyNowForm = document.getElementById("buy-now-form");
        if (!buyNowForm) return;

        const csrfToken = buyNowForm.querySelector('[name=csrfmiddlewaretoken]').value;

        buyNowForm.addEventListener("submit", async e => {
            e.preventDefault();
            const response = await fetch("{% url 'auctions:auction-buy-now' object.id %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken, "Accept": "application/json" },
            });
            const data = await response.json();

            titleErr.innerHTML = "";
            if (!data.success) {
                show(aucAlert);
                const li = document.createElement("li");
                li.textContent = data.error || "Buy Now failed.";
                titleErr.appendChild(li);
                return;
            }

            window.location.reload(); // reload on successful buy-now
        });
    }

    /* ============================================================
       BID LIST VISIBILITY
    ============================================================ */
    function updateBidListVisibility() {
        if (AUCTION_STATE !== "OPEN") return;

        if (bidList.children.length === 0) {
            hide(bidListSection);
            hide(highestBidBadge);
            show(noBidsFoundTxt);
            show(buyNowSection);
        } else {
            show(bidListSection);
            show(highestBidBadge);
            hide(noBidsFoundTxt);
            hide(buyNowSection);
        }
    }

    function addNewBid(bid) {
        if (AUCTION_STATE !== "OPEN") return;

        const li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <div>
                <strong>${bid.username}</strong>
                <small class="text-muted ms-2">${formatDate(bid.offer_time)}</small>
            </div>
            <span class="fw-semibold">€${bid.amount_display}</span>
        `;
        bidList.prepend(li);

        const currentHighest = parseFloat(highestBidBadge.dataset.amount);
        const newAmount = parseFloat(bid.amount_display);
        if (newAmount > currentHighest) {
            highestBidBadge.dataset.amount = newAmount;
            highestBidBadge.innerHTML = `<i class="bi bi-trophy me-1"></i> Highest: €${bid.amount_display}`;
            highestBidTag.innerHTML = `<p class="mb-0"><strong>Highest Offer:</strong> €${bid.amount_display}</p>`;
        }

        updateBidListVisibility();
    }

    /* ============================================================
       WEBSOCKET CONNECTION
       Reload page on auction status change
    ============================================================ */
    const auctionId = "{{ auction_id }}";
    const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const ws = new WebSocket(`${wsProtocol}${window.location.host}/ws/auction/${auctionId}/`);

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === "new_bid" && data.new_bid) addNewBid(data.new_bid);
        if (data.type === "buy_now") window.location.reload();
        if (data.type === "auction_status_update") window.location.reload();
    };

});
</script>
{% endblock %}