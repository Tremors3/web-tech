{% extends 'base/base_column.html' %}

{% block navbar %} {% include 'accounts/includes/signin_navbar.html' %} {% endblock %}

{% block title %}Sign In | Graba{% endblock %}

{% block main_column %}
<div class="card col-12 col-md-9 col-lg-6 col-xl-5 bg-white rounded shadow p-4">
    <h2 class="mb-4 text-center">Sign In</h2>
    <form method="post" novalidate>
        {% csrf_token %}
        {{ form.non_field_errors }}

        <!-- User Fields -->
        <h4 class="mt-4">User Info</h4>
        <div class="border rounded p-3 mb-3 bg-light-subtle">
            <div class="mb-3">
                {{ form.email.label_tag }} {{ form.email }} {{ form.email.errors }}
            </div>
            <div class="mb-3">
                {{ form.username.label_tag }} {{ form.username }} {{ form.username.errors }}
            </div>
            <div class="mb-3">
                {{ form.bio.label_tag }} {{ form.bio }} {{ form.bio.errors }}
            </div>
            <div class="mb-3">
                {{ form.password1.label_tag }} {{ form.password1 }} {{ form.password1.errors }}
            </div>
            <div class="mb-3">
                {{ form.password2.label_tag }} {{ form.password2 }} {{ form.password2.errors }}
            </div>
        </div>

        <!-- Legal Type -->
        <h4 class="mt-4">Select the Legal Type</h4>
        <div class="mb-3">
            {{ form.legal_type.label_tag }} {{ form.legal_type }} {{ form.legal_type.errors }}
        </div>

        <!-- Private User Fields -->
        <div id="private-fields" class="border rounded p-3 mb-3 bg-light-subtle">
            <h5>Private User Info</h5>
            <div class="mb-3">
                {{ form.first_name.label_tag }} {{ form.first_name }} {{ form.first_name.errors }}
            </div>
            <div class="mb-3">
                {{ form.last_name.label_tag }} {{ form.last_name }} {{ form.last_name.errors }}
            </div>
            <div class="mb-3">
                {{ form.fiscal_code.label_tag }} {{ form.fiscal_code }} {{ form.fiscal_code.errors }}
            </div>
        </div>

        <!-- Shopkeeper Fields -->
        <div id="shopkeeper-fields" class="border rounded p-3 mb-3 bg-light-subtle">
            <h5>Shopkeeper Info</h5>
            <div class="mb-3">
                {{ form.business_name.label_tag }} {{ form.business_name }} {{ form.business_name.errors }}
            </div>
            <div class="mb-3">
                {{ form.headquarters_address.label_tag }} {{ form.headquarters_address }} {{ form.headquarters_address.errors }}
            </div>
            <div class="mb-3">
                {{ form.iva_number.label_tag }} {{ form.iva_number }} {{ form.iva_number.errors }}
            </div>
        </div>

        <!-- Roles -->
        <h4 class="mt-4">Select the Roles</h4>
        <div class="mb-3">
            {{ form.role_types }} {{ form.role_types.errors }}
        </div>

        <!-- Buyer -->
        <div id="buyer-fields" class="border rounded p-3 mb-3 bg-light-subtle">
            <h5>Buyer Fields</h5>
            <div class="mb-3">
                {{ form.shipping_address.label_tag }} {{ form.shipping_address }} {{ form.shipping_address.errors }}
            </div>
        </div>

        <!-- Seller -->
        <div id="seller-fields" class="border rounded p-3 mb-3 bg-light-subtle">
            <h5>Seller Fields</h5>
            <div class="mb-3">
                {{ form.collection_address.label_tag }} {{ form.collection_address }} {{ form.collection_address.errors }}
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3 w-100">Sign In Now</button>
    </form>
</div>
{% endblock %}


{% block extra_js %}
<script>
    /* Toggle Private or Shopkeeper fields */
    document.addEventListener("DOMContentLoaded", function () {
        // Form field ids: "id_<field_name>"
        const legalTypeField = document.getElementById("id_legal_type");
        const privateFields = document.getElementById("private-fields");
        const shopkeeperFields = document.getElementById("shopkeeper-fields");

        function toggleLegalTypeFields() {
            const selected = legalTypeField.value;
            if (selected === "PRIVATE") {
                privateFields.style.display = "block";
                shopkeeperFields.style.display = "none";
            } else if (selected === "SHOPKEEPER") {
                privateFields.style.display = "none";
                shopkeeperFields.style.display = "block";
            } else {
                privateFields.style.display = "none";
                shopkeeperFields.style.display = "none";
            }
        }

        legalTypeField.addEventListener("change", toggleLegalTypeFields);
        toggleLegalTypeFields();
    });

    /* Show Roles fields */
    document.addEventListener("DOMContentLoaded", function () {
        const roleCheckboxes = document.querySelectorAll('input[name="role_types"]');
        const buyerFields = document.getElementById("buyer-fields");
        const sellerFields = document.getElementById("seller-fields");
        
        function toggleRoleFields() {
            let roles = Array.from(roleCheckboxes)
                            .filter(checkbox => checkbox.checked)
                            .map(checkbox => checkbox.value);
        
            buyerFields.style.display = roles.includes("BUYER") ? "block" : "none";
            sellerFields.style.display = roles.includes("SELLER") ? "block" : "none";
        }
        
        roleCheckboxes.forEach(cb => cb.addEventListener("change", toggleRoleFields));
        toggleRoleFields();
    });
</script>
{% endblock %}